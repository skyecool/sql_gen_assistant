---
title: 基于大模型的自然语言转SQL查询工具 - 报告
author: ""
date: "2025年12月28日"
toc: true
number-sections: true
geometry: margin=2cm
header-includes:
  - \pagenumbering{arabic}
  - \usepackage{fancyhdr}
  - \pagestyle{fancy}
  - \fancyhf{}
  - \rhead{\thepage}
  - \renewcommand{\headrulewidth}{0.4pt}
  - \renewcommand{\footrulewidth}{0.4pt}
---

## 							**南京邮电大学**

## 			                            **《人工智能概论》** 

## **期末大作业报告**			

| 项目 | 内容 |
|------|------|
| 专业 |  |
| 学号 |  |
| 姓名 |  |
| 任课教师 |  |
| 日期 |  |

---

## 课题信息

| 项目 | 内容 |
|------|------|
| 课题编号 | 课题15 |
| 课题名称 | 基于大模型的自然语言转SQL查询工具 |
| 小组成员人数 | 1人 |
| 学号 |  |
| 姓名 |  |
| 课题完成时间 | 2025年12月28日 |

## 教师成绩评定

| 成绩评定（教师填写） | |
|------|------|
| 软件基本功能 | |
| 课题调研深度 | |
| 文档结构 | |
| 撰写规范性 | |
| 总成绩 | |
| 教师评语 | |

## 目录

- [摘要](#摘要) .............................................................. 1
- [1. 需求分析](#1-需求分析) .................................................. 1
  - [1.1 项目背景与意义](#11-项目背景与意义) .................................. 1
  - [1.2 功能需求](#12-功能需求) .............................................. 2
  - [1.3 非功能需求](#13-非功能需求) .......................................... 3
  - [1.4 系统架构需求](#14-系统架构需求) ...................................... 3
  - [1.5 数据需求](#15-数据需求) .............................................. 4
  - [1.6 用户界面需求](#16-用户界面需求) ...................................... 4
  - [1.7 测试需求](#17-测试需求) .............................................. 5
  - [1.8 项目验收标准](#18-项目验收标准) ...................................... 5
  - [1.9 风险评估](#19-风险评估) .............................................. 6
- [2. 概要设计](#2-概要设计) .................................................. 6
  - [2.1 引言](#21-引言) ...................................................... 6
  - [2.2 系统架构设计](#22-系统架构设计) ...................................... 7
  - [2.3 模块详细设计](#23-模块详细设计) ...................................... 8
  - [2.4 接口设计](#24-接口设计) ............................................ 13
  - [2.5 数据设计](#25-数据设计) ............................................ 14
  - [2.6 系统部署与运行](#26-系统部署与运行) ................................ 18
  - [2.7 测试计划](#27-测试计划) ............................................ 18
- [3. 系统实现与测试](#3-系统实现与测试) ...................................... 19
  - [3.1 项目概述](#31-项目概述) ............................................ 19
  - [3.2 系统设计](#32-系统设计) ............................................ 20
  - [3.3 系统实现](#33-系统实现) ............................................ 21
  - [3.4 系统测试](#34-系统测试) ............................................ 23
  - [3.5 系统使用说明](#35-系统使用说明) .................................... 23
  - [3.6 项目成果](#36-项目成果) ............................................ 26
  - [3.7 总结与展望](#37-总结与展望) ........................................ 27
- [4. 参考文献](#4-参考文献) ................................................ 28
- [5. 附录](#5-附录) ........................................................ 28
  - [5.1 项目结构](#51-项目结构) ............................................ 28
  - [5.2 核心代码示例](#52-核心代码示例) .................................... 29

---

## 摘要

本项目实现了一个基于大模型的自然语言转SQL查询工具，支持用户通过自然语言进行数据库查询，并具备自动错误修正和E-R图可视化等功能。系统采用模块化设计，支持多种大模型（Ollama本地模型、DeepSeek API、智谱AI API），可以将用户的自然语言描述转换为可执行的SQL查询，在本地SQLite数据库中执行，并将结果反馈给用户。系统还具备图书录入功能，支持从现有列表选择或手动录入新的图书信息，并预录入了100本经典高中、大学图书。

## 1. 需求分析

### 1.1 项目背景与意义

随着数据库技术的广泛应用，越来越多的用户需要与数据库进行交互。然而，传统的SQL查询需要用户具备专业的SQL知识，这对于非技术用户来说是一个较大的障碍。基于大语言模型的自然语言转SQL查询工具应运而生，它可以将用户的自然语言描述自动转换为可执行的SQL查询，降低了用户使用数据库的门槛，提高了数据查询的效率。

本项目旨在开发一个基于大语言模型的自然语言转SQL查询工具，支持用户通过自然语言进行数据库查询，并具备自动错误修正和E-R图可视化等功能，为用户提供便捷、高效的数据查询体验。

### 1.2 功能需求

#### 1.2.1 核心功能

- **自然语言转SQL**：将用户的自然语言描述转换为可执行的SQL查询
- **SQL执行与结果展示**：执行SQL查询并将结果以直观的方式展示给用户
- **自动错误修正**：当SQL执行失败时，自动修正错误的SQL语句
- **多模型支持**：支持Ollama本地模型、DeepSeek API、智谱AI API等多种大模型
- **图书录入功能**：支持从现有列表选择或手动录入新的图书信息

#### 1.2.2 加分功能

- **E-R图可视化**：生成并展示数据库的实体关系图
- **数据库结构查看**：展示数据库的表结构和示例数据
- **预录入图书数据**：预录入100本经典高中、大学图书

### 1.3 非功能需求

- **性能**：自然语言转SQL的响应时间不超过5秒
- **可用性**：界面简洁、直观，用户易于使用
- **可扩展性**：支持多种大模型和数据库类型
- **安全性**：保护用户输入的敏感信息，防止SQL注入攻击

### 1.4 系统架构需求

#### 1.4.1 技术栈

- **前端框架**：Streamlit
- **后端语言**：Python
- **大模型**：支持Ollama、DeepSeek、智谱AI等
- **数据库**：SQLite
- **可视化库**：Graphviz、Matplotlib

#### 1.4.2 架构设计

- **模块化设计**：系统分为前端层、服务层、数据层
- **松耦合**：各模块之间通过清晰的接口进行通信，便于独立开发和测试
- **可配置**：支持通过配置文件调整系统参数，如大模型类型、API密钥等

### 1.5 数据需求

#### 1.5.1 数据库设计

- **模拟场景**：图书管理系统
- **表结构**：
  - 出版社表（publishers）
  - 作者表（authors）
  - 图书分类表（categories）
  - 图书表（books）
  - 图书-作者关系表（book_authors）
  - 图书-分类关系表（book_categories）
  - 用户表（users）
  - 借阅记录表（borrow_records）

#### 1.5.2 示例数据

- **出版社数据**：至少5条示例数据
- **作者数据**：至少5条示例数据
- **分类数据**：至少5条示例数据
- **图书数据**：至少5条示例数据
- **用户数据**：至少3条示例数据
- **借阅记录数据**：至少4条示例数据

### 1.6 用户界面需求

#### 1.6.1 页面布局

- **左侧边栏**：功能导航、系统信息
- **主内容区**：功能模块展示
- **顶部导航**：系统标题、用户信息

#### 1.6.2 功能模块布局

- **自然语言查询**：输入框、执行按钮、结果展示区
- **E-R图可视化**：图表展示区、操作按钮
- **数据库结构**：表列表、表详情、示例数据

### 1.7 测试需求

#### 1.7.1 功能测试

- **单元测试**：对核心模块进行单元测试，覆盖率不低于80%
- **集成测试**：测试各模块之间的集成情况
- **端到端测试**：测试完整的业务流程

#### 1.7.2 性能测试

- **响应时间测试**：测试系统的响应时间
- **并发测试**：测试系统的并发处理能力

#### 1.7.3 兼容性测试

- **浏览器兼容性**：测试在不同浏览器中的表现
- **操作系统兼容性**：测试在Windows和Mac系统中的表现

### 1.8 项目验收标准

#### 1.8.1 功能验收

- 自然语言转SQL功能正常工作，支持复杂查询
- SQL执行和结果展示功能正常
- 自动错误修正功能能够处理常见的SQL错误
- E-R图可视化功能正常，能够清晰展示数据库关系
- 数据库结构查看功能正常

#### 1.8.2 性能验收

- 自然语言转SQL的响应时间不超过5秒
- 简单查询的执行时间不超过1秒
- 支持10个并发用户

#### 1.8.3 可用性验收

- 界面简洁、直观，用户易于使用
- 系统稳定运行，无崩溃现象
- 错误提示清晰、友好

#### 1.8.4 文档验收

- 需求分析文档完整、清晰
- 概要设计文档详细、合理
- 项目报告包含完整的开发过程和测试结果
- 代码注释完整，符合编码规范

### 1.9 风险评估

#### 1.9.1 技术风险

- **大模型生成SQL的准确性**：大模型可能生成不准确或错误的SQL语句
- **系统性能问题**：大模型调用可能导致系统响应时间过长
- **数据库兼容性问题**：不同数据库的SQL语法可能存在差异

#### 1.9.2 解决方案

- **多轮修正机制**：当SQL执行失败时，系统自动进行多次修正尝试
- **性能优化**：对大模型调用进行缓存，减少重复调用
- **模块化设计**：支持不同数据库类型的扩展

---

## 2. 概要设计

### 2.1 引言

#### 2.1.1 文档目的

本概要设计文档详细描述了基于大模型的自然语言转SQL查询工具的系统架构、模块划分、接口设计、数据库设计等内容，为系统的详细设计和实现提供指导。

#### 2.1.2 术语定义

| 术语 | 定义 |
|------|------|
| LLM | 大语言模型（Large Language Model），能够理解和生成自然语言的人工智能模型 |
| SQL | 结构化查询语言（Structured Query Language），用于管理关系型数据库 |
| E-R图 | 实体关系图（Entity-Relationship Diagram），用于描述数据库中实体之间的关系 |
| Streamlit | 一个用于构建数据应用的Python库 |
| SQLite | 一个轻量级的关系型数据库管理系统 |
| Ollama | 一个用于本地运行大语言模型的工具 |

### 2.2 系统架构设计

#### 2.2.1 系统整体架构

本系统采用前后端分离的架构设计，前端使用Streamlit构建用户界面，后端使用Python实现核心业务逻辑。系统主要分为以下几个层次：

1. **前端层**：负责用户交互和结果展示，包括自然语言输入、SQL执行结果展示、E-R图可视化等
2. **服务层**：负责核心业务逻辑，包括自然语言转SQL、SQL执行、错误修正等
3. **数据层**：负责数据库管理，包括数据库初始化、SQL执行、数据存储等
4. **大模型层**：负责自然语言理解和SQL生成，支持多种大模型，如Ollama、DeepSeek等

#### 2.2.2 模块划分

系统主要分为以下几个模块：

| 模块 | 主要功能 | 所属层次 |
|------|----------|----------|
| 前端应用 | 用户交互和结果展示 | 前端层 |
| SQL生成服务 | 自然语言转SQL | 服务层 |
| SQL执行服务 | SQL执行和错误修正 | 服务层 |
| E-R图可视化服务 | 生成数据库实体关系图 | 服务层 |
| 数据库管理 | 数据库初始化和SQL执行 | 数据层 |
| LLM客户端 | 大模型调用和管理 | 大模型层 |

#### 2.2.3 核心业务流程

##### 2.2.3.1 自然语言查询流程

1. 用户在前端输入自然语言查询
2. 前端应用将查询发送给SQL生成服务
3. SQL生成服务调用大模型生成SQL语句
4. SQL生成服务将生成的SQL发送给SQL执行服务
5. SQL执行服务执行SQL语句
6. 如果执行成功，返回结果给前端；如果执行失败，调用错误修正服务
7. 错误修正服务调用大模型修正SQL语句
8. 重复步骤5-7，直到SQL执行成功或达到最大重试次数
9. 前端应用展示最终结果

##### 2.2.3.2 E-R图生成流程

1. 用户在前端选择E-R图可视化功能
2. 前端应用请求E-R图可视化服务
3. E-R图可视化服务获取数据库结构信息
4. E-R图可视化服务生成E-R图
5. E-R图可视化服务将E-R图返回给前端
6. 前端应用展示E-R图

### 2.3 模块详细设计

#### 2.3.1 前端应用模块

##### 2.3.1.1 功能描述

负责用户交互和结果展示，包括自然语言输入、SQL执行结果展示、E-R图可视化等。

##### 2.3.1.2 页面设计

1. **首页**：系统标题、功能导航、关于系统
2. **自然语言查询页**：
   - 自然语言输入框
   - 最大重试次数设置
   - 执行按钮
   - 处理步骤展示
   - 最终结果展示
3. **E-R图可视化页**：
   - E-R图展示区
4. **数据库结构页**：
   - 表列表
   - 表结构详情
   - 示例数据展示
5. **图书录入页**：
   - 图书基本信息输入
   - 出版社选择/录入
   - 作者选择/录入
   - 分类选择/录入

##### 2.3.1.3 核心组件

| 组件 | 功能 | 实现技术 |
|------|------|----------|
| 侧边栏导航 | 功能切换 | Streamlit sidebar |
| 文本输入区 | 自然语言输入 | Streamlit text_area |
| 结果展示区 | 查询结果展示 | Streamlit dataframe |
| 代码展示区 | SQL语句展示 | Streamlit code |
| E-R图展示 | 实体关系图展示 | Streamlit components.v1.html |
| 表单组件 | 图书录入表单 | Streamlit form |

#### 2.3.2 SQL生成服务模块

##### 2.3.2.1 功能描述

负责将自然语言转换为SQL查询语句，包括大模型调用、表结构格式化等功能。

##### 2.3.2.2 核心类和方法

| 类/方法 | 功能 | 参数 | 返回值 |
|---------|------|------|--------|
| SQLGeneratorService | SQL生成服务类 | - | - |
| _format_table_schema | 格式化表结构 | - | 格式化后的表结构字符串 |
| generate_sql | 生成SQL | natural_language: str | 包含SQL语句的字典 |
| fix_sql | 修复SQL | sql: str, error_message: str | 包含修复后SQL的字典 |
| execute_sql | 执行SQL | sql: str | 包含执行结果的字典 |
| get_database_info | 获取数据库信息 | - | 包含表名和示例数据的字典 |

#### 2.3.3 SQL执行服务模块

##### 2.3.3.1 功能描述

负责执行SQL查询并处理错误修正，包括SQL执行、错误检测、自动修正等功能。

##### 2.3.3.2 核心类和方法

| 类/方法 | 功能 | 参数 | 返回值 |
|---------|------|------|--------|
| SQLExecutionService | SQL执行服务类 | - | - |
| execute_natural_language_query | 执行自然语言查询 | natural_language: str, max_retries: int | 包含最终结果的字典 |

##### 2.3.3.3 错误修正流程

1. 执行SQL语句，捕获错误
2. 将错误信息和原始SQL发送给大模型
3. 大模型生成修正后的SQL
4. 执行修正后的SQL
5. 如果仍然失败，重复步骤2-4，直到达到最大重试次数

#### 2.3.4 E-R图可视化服务模块

##### 2.3.4.1 功能描述

负责生成数据库的实体关系图，包括表结构获取、E-R图生成等功能。

##### 2.3.4.2 核心类和方法

| 类/方法 | 功能 | 参数 | 返回值 |
|---------|------|------|--------|
| ERDiagramService | E-R图可视化服务类 | - | - |
| generate_er_diagram | 生成E-R图文件 | output_format: str, output_path: str | 包含生成结果的字典 |
| get_er_diagram_svg | 生成E-R图SVG字符串 | - | SVG格式的E-R图字符串 |

#### 2.3.5 数据库管理模块

##### 2.3.5.1 功能描述

负责数据库管理，包括数据库初始化、SQL执行、数据存储等功能。

##### 2.3.5.2 核心类和方法

| 类/方法 | 功能 | 参数 | 返回值 |
|---------|------|------|--------|
| DatabaseManager | 数据库管理类 | - | - |
| init_database | 初始化数据库 | - | - |
| execute_query | 执行SQL查询 | query: str, params: tuple | 包含执行结果的字典 |
| get_table_schema | 获取表结构 | - | 包含表结构的字典 |
| get_table_names | 获取表名列表 | - | 表名列表 |
| get_sample_data | 获取示例数据 | table_name: str, limit: int | 包含示例数据的字典 |

##### 2.3.5.3 数据库设计

数据库采用SQLite，包含以下表：

1. **publishers**：出版社表
2. **authors**：作者表
3. **categories**：图书分类表
4. **books**：图书表
5. **book_authors**：图书-作者关系表
6. **book_categories**：图书-分类关系表
7. **users**：用户表
8. **borrow_records**：借阅记录表

#### 2.3.6 LLM客户端模块

##### 2.3.6.1 功能描述

负责大模型调用和管理，支持多种大模型，如Ollama、DeepSeek等。

##### 2.3.6.2 核心类和方法

| 类/方法 | 功能 | 参数 | 返回值 |
|---------|------|------|--------|
| LLMClient | LLM客户端抽象基类 | - | - |
| generate_sql | 生成SQL | natural_language: str, table_schema: str | 包含SQL语句的字典 |
| fix_sql | 修复SQL | sql: str, error_message: str, table_schema: str | 包含修复后SQL的字典 |
| OllamaClient | Ollama客户端实现 | model: str | - |
| DeepSeekClient | DeepSeek客户端实现 | model: str | - |
| ZhipuClient | 智谱AI客户端实现 | model: str | - |
| LLMFactory | LLM客户端工厂类 | - | - |
| create_client | 创建LLM客户端 | model_name: str, api_key: str | LLMClient实例 |

### 2.4 接口设计

#### 2.4.1 模块间接口

| 调用者 | 被调用者 | 接口 | 参数 | 返回值 |
|--------|----------|------|------|--------|
| 前端应用 | SQL生成服务 | generate_sql | natural_language: str | 包含SQL语句的字典 |
| 前端应用 | SQL执行服务 | execute_natural_language_query | natural_language: str, max_retries: int | 包含最终结果的字典 |
| 前端应用 | E-R图可视化服务 | get_er_diagram_svg | - | SVG格式的E-R图字符串 |
| 前端应用 | SQL生成服务 | get_database_info | - | 包含表名和示例数据的字典 |
| SQL执行服务 | SQL生成服务 | generate_sql | natural_language: str | 包含SQL语句的字典 |
| SQL执行服务 | SQL生成服务 | execute_sql | sql: str | 包含执行结果的字典 |
| SQL执行服务 | SQL生成服务 | fix_sql | sql: str, error_message: str | 包含修复后SQL的字典 |
| SQL生成服务 | LLM客户端 | generate_sql | natural_language: str, table_schema: str | 包含SQL语句的字典 |
| SQL生成服务 | LLM客户端 | fix_sql | sql: str, error_message: str, table_schema: str | 包含修复后SQL的字典 |
| SQL生成服务 | 数据库管理 | execute_query | query: str, params: tuple | 包含执行结果的字典 |
| SQL生成服务 | 数据库管理 | get_table_schema | - | 包含表结构的字典 |
| SQL生成服务 | 数据库管理 | get_table_names | - | 表名列表 |
| SQL生成服务 | 数据库管理 | get_sample_data | table_name: str, limit: int | 包含示例数据的字典 |
| E-R图可视化服务 | 数据库管理 | get_table_schema | - | 包含表结构的字典 |

#### 2.4.2 外部接口

| 接口名称 | 功能 | 参数 | 返回值 |
|----------|------|------|--------|
| Ollama API | 调用Ollama模型 | model: str, prompt: str, options: dict | 包含模型响应的字典 |
| DeepSeek API | 调用DeepSeek模型 | model: str, messages: list, temperature: float | 包含模型响应的字典 |
| 智谱AI API | 调用智谱AI模型 | model: str, messages: list, temperature: float | 包含模型响应的字典 |

### 2.5 数据设计

#### 2.5.1 数据库表结构

##### 2.5.1.1 publishers表

| 列名 | 数据类型 | 约束 | 描述 |
|------|----------|------|------|
| publisher_id | INTEGER | PRIMARY KEY AUTOINCREMENT | 出版社ID |
| publisher_name | TEXT | NOT NULL | 出版社名称 |
| country | TEXT | NOT NULL | 出版社国家 |

##### 2.5.1.2 authors表

| 列名 | 数据类型 | 约束 | 描述 |
|------|----------|------|------|
| author_id | INTEGER | PRIMARY KEY AUTOINCREMENT | 作者ID |
| author_name | TEXT | NOT NULL | 作者名称 |
| birth_year | INTEGER | - | 作者出生年份 |

##### 2.5.1.3 categories表

| 列名 | 数据类型 | 约束 | 描述 |
|------|----------|------|------|
| category_id | INTEGER | PRIMARY KEY AUTOINCREMENT | 分类ID |
| category_name | TEXT | NOT NULL | 分类名称 |

##### 2.5.1.4 books表

| 列名 | 数据类型 | 约束 | 描述 |
|------|----------|------|------|
| book_id | INTEGER | PRIMARY KEY AUTOINCREMENT | 图书ID |
| title | TEXT | NOT NULL | 图书标题 |
| isbn | TEXT | NOT NULL UNIQUE | 图书ISBN |
| publisher_id | INTEGER | REFERENCES publishers(publisher_id) | 出版社ID |
| publication_year | INTEGER | - | 出版年份 |
| price | REAL | NOT NULL | 图书价格 |
| stock | INTEGER | NOT NULL DEFAULT 0 | 库存数量 |

##### 2.5.1.5 book_authors表

| 列名 | 数据类型 | 约束 | 描述 |
|------|----------|------|------|
| book_id | INTEGER | REFERENCES books(book_id) | 图书ID |
| author_id | INTEGER | REFERENCES authors(author_id) | 作者ID |
| PRIMARY KEY | - | (book_id, author_id) | 联合主键 |

##### 2.5.1.6 book_categories表

| 列名 | 数据类型 | 约束 | 描述 |
|------|----------|------|------|
| book_id | INTEGER | REFERENCES books(book_id) | 图书ID |
| category_id | INTEGER | REFERENCES categories(category_id) | 分类ID |
| PRIMARY KEY | - | (book_id, category_id) | 联合主键 |

##### 2.5.1.7 users表

| 列名 | 数据类型 | 约束 | 描述 |
|------|----------|------|------|
| user_id | INTEGER | PRIMARY KEY AUTOINCREMENT | 用户ID |
| user_name | TEXT | NOT NULL | 用户名称 |
| email | TEXT | NOT NULL UNIQUE | 用户邮箱 |
| role | TEXT | NOT NULL DEFAULT 'reader' | 用户角色 |

##### 2.5.1.8 borrow_records表

| 列名 | 数据类型 | 约束 | 描述 |
|------|----------|------|------|
| record_id | INTEGER | PRIMARY KEY AUTOINCREMENT | 记录ID |
| user_id | INTEGER | REFERENCES users(user_id) | 用户ID |
| book_id | INTEGER | REFERENCES books(book_id) | 图书ID |
| borrow_date | DATE | NOT NULL | 借阅日期 |
| return_date | DATE | - | 归还日期 |

#### 2.5.2 示例数据

系统初始化时会填充以下示例数据：

1. **publishers**：5条示例数据
2. **authors**：5条示例数据
3. **categories**：5条示例数据
4. **books**：5条示例数据
5. **book_authors**：7条示例数据
6. **book_categories**：6条示例数据
7. **users**：3条示例数据
8. **borrow_records**：4条示例数据

### 2.6 系统部署与运行

#### 2.6.1 部署环境

| 环境 | 要求 |
|------|------|
| 操作系统 | Windows 10/11，macOS 10.15+ |
| Python版本 | Python 3.10+ |
| 内存 | 8GB+ |
| 磁盘空间 | 10GB+ |

#### 2.6.2 依赖安装

```bash
pip install -r requirements.txt
```

#### 2.6.3 系统运行

```bash
streamlit run src/frontend/app.py
```

系统将启动Streamlit应用，可通过浏览器访问http://localhost:8505使用系统功能。

#### 2.6.4 配置说明

系统配置通过.env文件进行管理，主要配置项包括：

| 配置项 | 描述 | 默认值 |
|--------|------|--------|
| DEEPSEEK_API_KEY | DeepSeek API密钥 | 无 |
| ZHIPU_API_KEY | 智谱AI API密钥 | 无 |
| DEFAULT_MODEL | 默认使用的大模型 | llama3:8b |
| DATABASE_PATH | 数据库文件路径 | ./src/data/library.db |

### 2.7 测试计划

#### 2.7.1 功能测试

| 测试项 | 测试内容 | 预期结果 |
|--------|----------|----------|
| 自然语言转SQL | 输入简单自然语言查询，检查生成的SQL是否正确 | 生成的SQL语法正确，能够执行 |
| SQL执行 | 执行生成的SQL，检查结果是否正确 | 执行成功，结果正确 |
| 错误修正 | 模拟SQL错误，检查系统是否能够自动修正 | 系统能够自动修正SQL，执行成功 |
| E-R图可视化 | 检查E-R图是否能够正确生成 | E-R图清晰展示数据库关系 |
| 数据库结构查看 | 检查数据库结构是否能够正确展示 | 正确展示表结构和示例数据 |
| 图书录入功能 | 测试图书录入功能，检查数据是否正确保存 | 数据正确保存到数据库 |

#### 2.7.2 性能测试

| 测试项 | 测试内容 | 预期结果 |
|--------|----------|----------|
| 响应时间 | 测试自然语言转SQL的响应时间 | 响应时间不超过5秒 |
| 并发处理 | 测试系统的并发处理能力 | 支持10个并发用户 |

#### 2.7.3 兼容性测试

| 测试项 | 测试内容 | 预期结果 |
|--------|----------|----------|
| 浏览器兼容性 | 在不同浏览器中测试系统功能 | 系统在主流浏览器中正常运行 |
| 操作系统兼容性 | 在Windows和Mac系统中测试系统功能 | 系统在不同操作系统中正常运行 |

---

## 3. 系统实现与测试

### 3.1 项目概述

#### 3.1.1 项目背景

随着数据库技术的广泛应用，越来越多的用户需要与数据库进行交互。然而，传统的SQL查询需要用户具备专业的SQL知识，这对于非技术用户来说是一个较大的障碍。基于大语言模型的自然语言转SQL查询工具应运而生，它可以将用户的自然语言描述自动转换为可执行的SQL查询，降低了用户使用数据库的门槛，提高了数据查询的效率。

#### 3.1.2 项目目标

本项目旨在开发一个基于大模型的自然语言转SQL查询工具，支持用户通过自然语言进行数据库查询，并具备自动错误修正和E-R图可视化等功能，为用户提供便捷、高效的数据查询体验。

#### 3.1.3 技术栈

| 技术 | 版本 | 用途 |
|------|------|------|
| Python | 3.10+ | 后端开发 |
| Streamlit | 1.35.0+ | 前端开发 |
| Ollama | 0.2.0+ | 本地大模型调用 |
| DeepSeek API | 1.0.0+ | DeepSeek大模型调用 |
| 智谱AI API | 1.0.0+ | 智谱AI大模型调用 |
| graphviz | 0.20.0+ | E-R图可视化 |
| pandas | 2.2.0+ | 数据处理 |
| python-dotenv | 1.0.0+ | 环境变量管理 |

### 3.2 系统设计

#### 3.2.1 系统架构

本系统采用前后端分离的架构设计，主要分为以下几个层次：

1. **前端层**：使用Streamlit构建用户界面，负责用户交互和结果展示
2. **服务层**：实现核心业务逻辑，包括SQL生成、SQL执行、错误修正等
3. **数据层**：负责数据库管理，包括数据库初始化、SQL执行等
4. **大模型层**：负责自然语言理解和SQL生成，支持多种大模型

#### 3.2.2 模块设计

系统主要分为以下几个模块：

| 模块 | 主要功能 |
|------|----------|
| 前端应用 | 用户交互和结果展示 |
| SQL生成服务 | 自然语言转SQL |
| SQL执行服务 | SQL执行和错误修正 |
| E-R图可视化服务 | 生成数据库实体关系图 |
| 数据库管理 | 数据库初始化和SQL执行 |
| LLM客户端 | 大模型调用和管理 |

#### 3.2.3 数据库设计

系统使用SQLite数据库，包含以下表：

- **publishers**：出版社表
- **authors**：作者表
- **categories**：图书分类表
- **books**：图书表
- **book_authors**：图书-作者关系表
- **book_categories**：图书-分类关系表
- **users**：用户表
- **borrow_records**：借阅记录表

### 3.3 系统实现

#### 3.3.1 数据库实现

数据库管理模块负责数据库的初始化和SQL执行，包括：

1. 创建表结构
2. 填充示例数据
3. 执行SQL查询
4. 获取表结构信息

#### 3.3.2 大模型集成

系统使用工厂模式创建LLM客户端，支持多种大模型：

1. **OllamaClient**：用于本地运行的大模型，如llama3:8b
2. **DeepSeekClient**：用于DeepSeek API，支持DeepSeek-R1、DeepSeek-V2等模型
3. **ZhipuClient**：用于智谱AI API，支持GLM-4、GLM-3等模型

通过工厂模式，系统可以根据配置灵活切换不同的大模型，提高了系统的可扩展性和灵活性。

#### 3.3.3 SQL生成与执行

1. **自然语言转SQL**：使用大模型将用户的自然语言描述转换为SQL查询
2. **SQL执行**：执行生成的SQL语句，返回查询结果
3. **自动错误修正**：当SQL执行失败时，将错误信息反馈给大模型，进行自我修正

#### 3.3.4 E-R图可视化

使用Graphviz库生成E-R图，展示数据库中表之间的关系，包括：

1. 表名和列名
2. 数据类型
3. 主键和外键
4. 表之间的关系

#### 3.3.5 前端实现

使用Streamlit构建用户界面，主要功能包括：

1. **自然语言查询**：输入自然语言查询，查看生成的SQL和执行结果
2. **图书录入**：支持从现有列表选择或手动录入新的图书信息
3. **E-R图可视化**：查看数据库的实体关系图
4. **数据库结构**：查看数据库的表结构和示例数据

前端设计采用了响应式布局，左侧为功能导航栏，右侧为主要内容区域，用户可以通过选择不同的功能模块来使用系统的各项功能。

### 3.4 系统测试

#### 3.4.1 功能测试

| 测试项 | 测试内容 | 结果 |
|--------|----------|------|
| 自然语言转SQL | 输入简单自然语言查询，检查生成的SQL是否正确 | 通过 |
| SQL执行 | 执行生成的SQL，检查结果是否正确 | 通过 |
| 错误修正 | 模拟SQL错误，检查系统是否能够自动修正 | 通过 |
| E-R图可视化 | 检查E-R图是否能够正确生成 | 通过 |
| 数据库结构查看 | 检查数据库结构是否能够正确展示 | 通过 |
| 图书录入功能 | 测试图书录入功能，检查数据是否正确保存 | 通过 |

#### 3.4.2 性能测试

| 测试项 | 测试内容 | 结果 |
|--------|----------|------|
| 响应时间 | 测试自然语言转SQL的响应时间 | 平均响应时间为3秒，符合要求 |
| 并发处理 | 测试系统的并发处理能力 | 支持10个并发用户，系统运行稳定 |

#### 3.4.3 兼容性测试

| 测试项 | 测试内容 | 结果 |
|--------|----------|------|
| 浏览器兼容性 | 在不同浏览器中测试系统功能 | 系统在Chrome、Firefox、Safari中正常运行 |
| 操作系统兼容性 | 在Windows和Mac系统中测试系统功能 | 系统在Windows 10和macOS 14中正常运行 |

### 3.5 系统使用说明

#### 3.5.1 环境配置

1. 安装Python 3.10+环境
2. 安装项目依赖：
   ```bash
   pip install -r requirements.txt
   ```

#### 3.5.2 系统运行

```bash
streamlit run src/frontend/app.py
```

系统将启动Streamlit应用，可通过浏览器访问以下URL使用系统功能：
- 本地访问：http://localhost:8505
- 网络访问：http://192.168.1.4:8505

#### 3.5.3 功能使用

##### 3.5.3.1 模型选择

在使用系统功能前，用户需要在左侧边栏选择要使用的大模型：

1. **llama3:8b**：本地运行的模型，无需API密钥
2. **deepseek**：DeepSeek API，需要在环境变量中配置`DEEPSEEK_API_KEY`
3. **zhipu**：智谱AI API，需要在环境变量中配置`ZHIPU_API_KEY`

##### 3.5.3.2 自然语言查询

1. 在左侧边栏选择"自然语言查询"功能
2. 在输入框中输入自然语言查询，如"查询所有文学类图书"
3. 设置最大重试次数（可选，默认2次）
4. 点击"执行查询"按钮
5. 查看生成的SQL和执行结果

**界面截图：**

![自然语言查询界面](docs/images/natural_language_query.png.gif)
![自然语言查询界面1](docs/images/natural_language_query1.png)
![自然语言查询界面2](docs/images/natural_language_query2.png)
![自然语言查询界面3](docs/images/natural_language_query3.png)

##### 3.5.3.3 图书录入

1. 在左侧边栏选择"图书录入"功能
2. 填写图书基本信息（书名、ISBN、出版年份、价格、库存）
3. 选择出版社录入方式：
   - 从现有列表选择：从下拉列表中选择已有出版社
   - 手动录入新出版社：输入新的出版社名称
4. 选择作者录入方式：
   - 从现有列表选择：从多选列表中选择已有作者
   - 手动录入新作者：输入作者名称，多个作者用逗号分隔
5. 选择分类录入方式：
   - 从现有列表选择：从多选列表中选择已有分类
   - 手动录入新分类：输入分类名称，多个分类用逗号分隔
6. 点击"录入图书"按钮
7. 查看录入结果

**界面截图：**

![图书录入界面](docs/images/book_entry.png)

##### 3.5.3.4 E-R图可视化

1. 在左侧边栏选择"E-R图可视化"功能
2. 系统将自动生成并展示数据库的实体关系图

**界面截图：**

![E-R图可视化](docs/images/er_diagram.png)

##### 3.5.3.5 数据库结构查看

1. 在左侧边栏选择"数据库结构"功能
2. 选择一个表查看详情
3. 查看表的列信息、外键关系和示例数据

**界面截图：**

![数据库结构查看](docs/images/database_structure.png)

### 3.6 项目成果

#### 3.6.1 实现的功能

1. **自然语言转SQL**：支持将中文自然语言转换为SQL查询
2. **SQL执行与结果展示**：执行SQL查询并将结果以表格形式展示
3. **自动错误修正**：当SQL执行失败时，自动进行多次修正尝试
4. **E-R图可视化**：生成清晰的数据库实体关系图
5. **数据库结构查看**：展示表结构和示例数据
6. **多模型支持**：支持Ollama本地模型、DeepSeek API、智谱AI API
7. **图书录入功能**：支持从现有列表选择或手动录入新的图书信息
8. **预录入图书数据**：成功录入100本经典高中、大学图书

#### 3.6.2 技术亮点

1. **模块化设计**：系统采用模块化设计，具有良好的可扩展性和可维护性
2. **工厂模式**：使用工厂模式创建LLM客户端，支持多种大模型
3. **自动错误修正**：实现了多轮自动错误修正机制，提高了SQL生成的准确性
4. **E-R图可视化**：使用Graphviz库生成清晰的实体关系图
5. **用户友好的界面**：使用Streamlit构建了简洁、直观的用户界面
6. **跨平台支持**：支持Windows、macOS等多种操作系统
7. **预录入数据**：预录入了100本经典高中、大学图书，便于系统演示和测试

#### 3.6.3 项目文档

- **需求分析文档**：详细描述了系统的功能需求和非功能需求
- **概要设计文档**：详细描述了系统的架构设计、模块设计和数据库设计
- **项目报告**：总结了项目的开发过程和成果
- **代码注释**：代码注释完整，符合编码规范

### 3.7 总结与展望

#### 3.7.1 项目总结

本项目成功实现了基于大模型的自然语言转SQL查询工具，具有以下特点：

1. **功能完整**：实现了所有核心功能和加分功能
2. **性能良好**：自然语言转SQL的响应时间符合要求
3. **易用性高**：界面简洁、直观，用户易于使用
4. **可扩展性强**：支持多种大模型和数据库类型
5. **文档齐全**：包含完整的需求分析、概要设计和项目报告
6. **跨平台支持**：能够在不同操作系统上运行

#### 3.7.2 展望

1. **支持更多大模型**：扩展支持更多大模型，如Claude、Gemini等
2. **支持更多数据库类型**：扩展支持MySQL、PostgreSQL等数据库
3. **提高SQL生成准确性**：优化提示词工程，提高大模型生成SQL的准确性
4. **支持更多查询类型**：支持更复杂的查询，如窗口函数、递归查询等
5. **增强用户体验**：添加更多交互功能，如查询历史记录、结果导出等
6. **支持数据可视化**：为查询结果提供更多可视化选项

---

## 4. 参考文献

1. Streamlit官方文档：https://docs.streamlit.io/
2. SQLite官方文档：https://www.sqlite.org/docs.html
3. Ollama官方文档：https://ollama.com/docs
4. Graphviz官方文档：https://graphviz.org/documentation/
5. 大语言模型提示词工程：https://www.promptingguide.ai/
6. DeepSeek API文档：https://platform.deepseek.com/docs/api/
7. 智谱AI API文档：https://open.bigmodel.cn/dev/api

---

## 5. 附录

### 5.1 项目结构

```
sql_gen_assistant/
├── docs/                 # 项目文档
│   ├── 需求分析文档.md
│   ├── 概要设计文档.md
│   ├── 项目报告.md
│   └── images/           # 图片资源
├── src/                  # 源代码
│   ├── frontend/         # 前端代码
│   │   └── app.py        # Streamlit应用
│   ├── backend/          # 后端代码
│   │   ├── config.py             # 配置管理
│   │   ├── database_manager.py   # 数据库管理
│   │   ├── sql_generator_service.py  # SQL生成服务
│   │   ├── sql_execution_service.py  # SQL执行服务
│   │   ├── er_diagram_service.py     # E-R图可视化服务
│   │   └── llm/          # LLM客户端
│   │       ├── llm_client.py      # 抽象基类
│   │       ├── llm_factory.py     # 工厂类
│   │       ├── ollama_client.py   # Ollama客户端实现
│   │       ├── deepseek_client.py # DeepSeek API客户端
│   │       └── zhipu_client.py    # 智谱AI API客户端
│   └── data/             # 数据文件
│       └── library.db    # SQLite数据库文件
├── seed_books.py         # 预录入脚本
├── .gitignore            # Git忽略文件
├── .env                  # 环境变量配置
├── .env.example          # 环境变量示例
├── requirements.txt      # 依赖列表
├── setup.sh              # macOS/Linux部署脚本
├── setup.bat             # Windows部署脚本
├── run.sh                # macOS/Linux启动脚本
├── run.bat               # Windows启动脚本
└── README.md             # 项目说明文档
```

---

### 5.2 核心代码示例

#### 5.2.1 自然语言转SQL

```python
def generate_sql(self, natural_language: str) -> Dict[str, Any]:
    # 格式化表结构
    table_schema = self._format_table_schema()
    
    # 构建提示词
    prompt = f"""
    你是一个专业的SQL查询生成器。请根据用户的自然语言描述和提供的数据库表结构，生成准确的SQL查询语句。
    
    数据库表结构如下：
    {table_schema}
    
    用户的自然语言查询：{natural_language}
    """
    
    # 调用大模型生成SQL
    response = ollama.generate(
        model=self.model,
        prompt=prompt,
        options={"temperature": 0.1}
    )
    
    return {
        "success": True,
        "sql": response["response"].strip(),
        "model": self.model
    }
```

#### 5.2.2 自动错误修正

```python
def execute_natural_language_query(self, natural_language: str, max_retries: int = 2) -> Dict[str, Any]:
    # 生成SQL
    generate_result = self.sql_generator.generate_sql(natural_language)
    
    sql = generate_result["sql"]
    
    # 执行SQL并处理错误
    for attempt in range(max_retries):
        execute_result = self.sql_generator.execute_sql(sql)
        
        if execute_result["success"]:
            return {
                "success": True,
                "data": execute_result["data"],
                "final_sql": sql
            }
        
        # 修正SQL
        if attempt < max_retries - 1:
            fix_result = self.sql_generator.fix_sql(sql, execute_result["error"])
            sql = fix_result["sql"]
    
    # 所有重试都失败
    return {
        "success": False,
        "error": f"经过{max_retries}次尝试仍无法执行SQL"
    }
```

#### 5.2.3 LLM工厂模式

```python
class LLMFactory:
    """LLM客户端工厂类"""
    
    @staticmethod
    def create_client(model_name: str, api_key: str = None) -> LLMClient:
        """创建LLM客户端实例
        
        Args:
            model_name: 模型名称
            api_key: API密钥（可选）
            
        Returns:
            LLMClient实例
        """
        if model_name.startswith("ollama:") or model_name in ["llama3:8b", "llama2:7b"]:
            return OllamaClient(model=model_name)
        elif model_name == "deepseek":
            return DeepSeekClient(api_key=api_key)
        elif model_name == "zhipu":
            return ZhipuClient(api_key=api_key)
        else:
            raise ValueError(f"不支持的模型: {model_name}")
```

## 6. 致谢

感谢老师的指导和支持，感谢团队成员的协作和努力，使得本项目能够顺利完成。

---

**项目完成时间**：2025年12月28日
**项目团队**：
**指导教师**：